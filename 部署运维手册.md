# kkFileView 4.4.0 部署运维手册

> 作者: ZHANGCHAO  
> 版本: 4.4.0  
> 日期: 2025-10-11

---

## 项目概述

**kkFileView** 是一个基于 Spring Boot 的文档在线预览解决方案，支持多种文档格式的在线预览。

### 支持的文件格式
- **Office文档**: doc, docx, xls, xlsx, ppt, pptx, csv等
- **国产Office**: wps, dps, et等
- **PDF文档**: pdf, ofd等
- **CAD图纸**: dwg, dxf等
- **图片**: jpg, png, gif, bmp, tiff等
- **压缩包**: zip, rar, 7z等
- **多媒体**: mp3, mp4, flv, avi等
- **代码文本**: java, py, js, xml, md等
- **3D模型**: obj, stl, fbx等

### 版本信息
- **当前版本**: 4.4.0
- **Java版本**: 1.8
- **Spring Boot**: 2.4.2
- **文档转换引擎**: LibreOffice 7.3+

---

## 技术架构

### Docker镜像分层设计

本项目采用**两阶段镜像构建**策略，优化构建速度和镜像复用：

```
┌─────────────────────────────────────┐
│   kkfileview:4.4.0 (应用镜像)        │
│   - 应用JAR包                        │
│   - 配置文件                         │
│   - 启动脚本                         │
├─────────────────────────────────────┤
│   keking/kkfileview-base:4.4.0      │
│   (基础镜像 - 约1.5GB)               │
│   - Ubuntu 24.04                    │
│   - OpenJDK 8                       │
│   - LibreOffice 7.3                 │
│   - 中文字体包                       │
│   - 系统依赖                         │
└─────────────────────────────────────┘
```

**优点**:
- 基础镜像很少变更，只需构建一次
- 应用镜像构建快速（<1分钟）
- 便于版本迭代和快速发布

### 项目目录结构

```
file-online-preview/
├── docker/
│   └── kkfileview-base/
│       ├── Dockerfile          # 基础镜像Dockerfile
│       └── fonts/              # 中文字体目录
├── server/
│   ├── src/                    # 源代码
│   ├── target/
│   │   └── kkFileView-*.tar.gz # Maven构建产物
│   └── pom.xml
├── Dockerfile                  # 应用镜像Dockerfile
├── docker-compose.yml          # 编排文件
├── .dockerignore              # 构建忽略文件
├── pom.xml                     # 父级POM
└── DOCKER部署运行手册.md        # 本文档
```

---

## 📋 目录

1. [首次部署](#首次部署)
2. [代码更新](#代码更新)
3. [镜像构建说明](#镜像构建说明)
4. [常用运维命令](#常用运维命令)
5. [故障排查](#故障排查)

---

## 🚀 首次部署

### 前提条件

**服务器环境（CentOS 7/8）**
- Docker 20.10+
- Docker Compose 2.0+
- 2GB+ 内存
- 10GB+ 磁盘空间

### 部署步骤

#### 1. 本地构建

```powershell
# 在项目根目录执行
.\build.bat
```
或者手动构建
```powershell
# 清理旧文件
mvn clean

# 打包（跳过测试以加快速度）
mvn package -DskipTests
```

生成文件：
- `server/target/kkFileView-4.4.0.tar.gz` (应用包)
- `server/target/kkFileView-4.4.0.zip` (Windows 部署包)

#### 2. 准备部署文件

需要上传到服务器的文件：
```
kkfileview/
├── docker/kkfileview-base/          # 基础镜像文件
│   ├── Dockerfile
│   └── fonts/                       # 中文字体
├── server/target/
│   └── kkFileView-4.4.0.tar.gz     # 应用包
├── Dockerfile                       # 应用镜像构建文件
└── docker-compose.yml               # Docker Compose 配置
```

#### 3. 上传到服务器

```bash
# 使用 scp 或 WinSCP/FileZilla 上传整个项目
scp -r kkfileview root@your-server-ip:/opt/
```

#### 4. 在服务器上构建和部署

```bash
# SSH 登录
ssh root@your-server-ip
cd /opt/kkfileview

# 步骤 1: 构建基础镜像（首次需要，约 10-20 分钟）
cd docker/kkfileview-base
docker build -t keking/kkfileview-base:4.4.0 .
cd ../..

# 步骤 2: 构建应用镜像（约 2-3 分钟）
docker build -t kkfileview:4.4.0 .

# 步骤 3: 创建数据目录
mkdir -p data/file data/config

# 步骤 4: 启动服务
docker-compose up -d

# 步骤 5: 查看日志
docker-compose logs -f kkfileview
```

#### 5. 配置防火墙

```bash
sudo firewall-cmd --permanent --add-port=8012/tcp
sudo firewall-cmd --reload
```

#### 6. 访问服务

浏览器访问: `http://your-server-ip:8012`

---

## 🔄 代码更新

当修改了源码后，只需重新构建应用镜像，**不需要**重新构建基础镜像。

### 方式一：只上传 tar.gz（推荐）

#### 本地操作

```powershell
# 1. 执行更新脚本
.\update.bat

# 2. 上传新的 tar.gz
scp server\target\kkFileView-4.4.0.tar.gz root@your-server:/opt/kkfileview/server/target/
```

#### 服务器操作

```bash
# SSH 登录
ssh root@your-server-ip
cd /opt/kkfileview

# 方式 A: 使用更新脚本
chmod +x server-update.sh
dos2unix server-update.sh  # 如果有换行符问题
./server-update.sh

# 方式 B: 手动执行
docker-compose down
docker build -t kkfileview:4.4.0 . --no-cache
docker-compose up -d
docker-compose logs -f
```

### 方式二：上传完整项目

```powershell
# 本地重新打包并上传
.\update.bat
scp -r update-files/* root@your-server:/opt/kkfileview/
```

```bash
# 服务器重新构建
cd /opt/kkfileview
docker-compose down
docker build -t kkfileview:4.4.0 . --no-cache
docker-compose up -d
```

---

## 🏗️ 镜像构建说明

### 镜像层级关系

```
Ubuntu 24.04
    ↓
keking/kkfileview-base:4.4.0  ← 基础镜像（首次构建，很少变动）
    ├─ OpenJDK 8
    ├─ LibreOffice
    ├─ 中文字体
    └─ 系统配置
    ↓
kkfileview:4.4.0              ← 应用镜像（每次代码更新都需重建）
    └─ kkFileView-4.4.0.tar.gz
```

### 何时需要重建基础镜像？

❌ **不需要重建基础镜像的情况：**
- 修改了 Java 代码
- 修改了配置文件
- 修改了前端页面
- 升级了依赖包版本

✅ **需要重建基础镜像的情况：**
- 升级 JDK 版本
- 升级 LibreOffice 版本
- 添加新的系统字体
- 修改基础系统配置

### 镜像大小

- 基础镜像: ~1.2GB
- 应用镜像: ~1.5GB
- 应用包 tar.gz: ~286MB

---

## 📝 常用运维命令

### Docker Compose 命令

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f kkfileview

# 查看最近 100 行日志
docker-compose logs --tail=100 kkfileview

# 进入容器
docker-compose exec kkfileview bash
```

### Docker 镜像管理

```bash
# 查看所有镜像
docker images

# 查看 kkfileview 相关镜像
docker images | grep kkfileview

# 删除旧的应用镜像
docker rmi kkfileview:4.4.0

# 删除未使用的镜像
docker image prune -a

# 查看镜像详情
docker inspect kkfileview:4.4.0
```

### 容器管理

```bash
# 查看运行中的容器
docker ps

# 查看所有容器
docker ps -a

# 查看容器资源使用
docker stats kkfileview

# 查看容器日志
docker logs -f kkfileview

# 重启容器
docker restart kkfileview
```

### 数据管理

```bash
# 备份数据
cd /opt/kkfileview
tar -czf kkfileview-data-backup-$(date +%Y%m%d).tar.gz data/

# 清理缓存文件
rm -rf data/file/*

# 查看磁盘使用
du -sh data/
df -h
```

---

## 🐛 故障排查

### 问题 1: 容器无法启动

**症状**: `docker-compose ps` 显示容器状态为 Exit

**排查步骤**:

```bash
# 1. 查看完整日志
docker-compose logs --tail=200 kkfileview

# 2. 检查端口占用
netstat -nltp | grep 8012

# 3. 检查磁盘空间
df -h

# 4. 尝试重新创建容器
docker-compose down
docker-compose up -d
```

### 问题 2: 服务无法访问

**症状**: 浏览器无法打开 http://server-ip:8012

**排查步骤**:

```bash
# 1. 检查容器是否运行
docker-compose ps

# 2. 检查防火墙
firewall-cmd --list-ports
sudo firewall-cmd --permanent --add-port=8012/tcp
sudo firewall-cmd --reload

# 3. 检查服务是否监听
docker-compose exec kkfileview netstat -nltp | grep 8012

# 4. 从容器内部测试
docker-compose exec kkfileview curl http://localhost:8012
```

### 问题 3: 文件预览失败

**症状**: 上传文件后无法预览或转换失败

**排查步骤**:

```bash
# 1. 查看应用日志
docker-compose logs -f kkfileview

# 2. 进入容器检查
docker-compose exec kkfileview bash
cd /opt/kkFileView-4.4.0/log
tail -f kkFileView.log

# 3. 检查 LibreOffice
docker-compose exec kkfileview which libreoffice

# 4. 检查文件权限
docker-compose exec kkfileview ls -la /opt/kkFileView-4.4.0/file/
```

### 问题 4: 内存不足

**症状**: 容器频繁重启或 OOM

**解决方案**:

```bash
# 1. 查看内存使用
docker stats kkfileview

# 2. 在 docker-compose.yml 中限制内存
# 添加以下配置:
deploy:
  resources:
    limits:
      memory: 2G
    reservations:
      memory: 1G

# 3. 重启服务
docker-compose down
docker-compose up -d
```

### 问题 5: 构建镜像失败

**症状**: docker build 报错

**常见原因**:

```bash
# 1. 基础镜像拉取失败
# 解决: 配置 Docker 镜像加速器

# 2. 网络超时
# 解决: 使用国内镜像源或代理

# 3. tar.gz 文件不存在
# 解决: 检查文件路径
ls -lh server/target/kkFileView-4.4.0.tar.gz

# 4. 磁盘空间不足
# 解决: 清理磁盘
docker system prune -a
```

### 问题 6: 脚本执行报错 ^M

**症状**: `-bash: ./xxx.sh: /bin/bash^M: bad interpreter`

**解决方案**:

```bash
# 安装 dos2unix
yum install -y dos2unix

# 转换文件
dos2unix *.sh

# 或使用 sed
sed -i 's/\r$//' *.sh

# 添加执行权限
chmod +x *.sh
```

---

## 📊 性能优化建议

### 1. JVM 参数调优

修改 `Dockerfile` 的 ENTRYPOINT:

```dockerfile
ENTRYPOINT ["java", \
    "-Xms1g", \
    "-Xmx2g", \
    "-XX:+UseG1GC", \
    "-XX:MaxGCPauseMillis=200", \
    "-Dfile.encoding=UTF-8", \
    "-Dspring.config.location=/opt/kkFileView-4.4.0/config/application.properties", \
    "-jar", \
    "/opt/kkFileView-4.4.0/bin/kkFileView-4.4.0.jar"]
```

### 2. 使用 Redis 缓存

修改 `docker-compose.yml`:

```yaml
services:
  redis:
    image: redis:7-alpine
    container_name: kkfileview-redis
    restart: always
    volumes:
      - ./data/redis:/data
    networks:
      - kkfileview-network

  kkfileview:
    environment:
      - KK_CACHE_TYPE=redis
      - KK_SPRING_REDISSON_ADDRESS=redis:6379
```

### 3. 定期清理缓存

```bash
# 添加定时任务
crontab -e

# 每天凌晨 3 点清理缓存
0 3 * * * cd /opt/kkfileview && rm -rf data/file/* && docker-compose restart
```

---

## 🔐 安全建议

1. **修改默认端口**
2. **启用 HTTPS**
3. **设置信任站点白名单**
4. **定期更新镜像**
5. **限制上传文件大小和类型**
6. **定期备份数据**

---

## 📞 技术支持

- 官方文档: https://kkview.cn
- GitHub: https://github.com/kekingcn/kkFileView
- 问题反馈: https://github.com/kekingcn/kkFileView/issues

---

**最后更新: 2025-10-11**
