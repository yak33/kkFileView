version: '3.8'

services:
  kkfileview:
    # 使用本地构建的镜像
    image: kkfileview:4.4.0
    container_name: kkfileview
    restart: always
    ports:
      - "8012:8012"
    environment:
      # 服务端口
      - KK_SERVER_PORT=8012
      # 上下文路径
      - KK_CONTEXT_PATH=/
      # Office Home 路径（使用默认）
      - KK_OFFICE_HOME=default
      # 文件存储目录
      - KK_FILE_DIR=default
      # 是否启用缓存
      - KK_CACHE_ENABLED=true
      # 缓存类型：jdk（默认）或 redis
      - KK_CACHE_TYPE=jdk
      # 缓存自动清理
      - KK_CACHE_CLEAN_ENABLED=true
      - KK_CACHE_CLEAN_CRON=0 0 3 * * ?
      # 预览服务地址（根据实际情况修改）
      - KK_BASE_URL=default
      # 信任站点（可选，多个用逗号隔开）
      - KK_TRUST_HOST=default
      # 水印设置（默认不启用）
      - WATERMARK_TXT=
      # PDF 设置
      - KK_PDF2JPG_DPI=144
      - KK_PDF_PRINT_DISABLE=true
      - KK_PDF_DOWNLOAD_DISABLE=true
      # Office 预览类型：image 或 pdf
      - KK_OFFICE_PREVIEW_TYPE=image
      # 删除源文件以节约空间
      - KK_DELETE_SOURCE_FILE=true
    volumes:
      # 持久化文件存储目录
      - ./data/file:/opt/kkFileView-4.4.0/file
      # 持久化配置文件（可选）
      - ./data/config:/opt/kkFileView-4.4.0/config
    networks:
      - kkfileview-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8012/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  kkfileview-network:
    driver: bridge

# 如果需要使用 Redis 作为缓存，可以取消以下注释
#  redis:
#    image: redis:7-alpine
#    container_name: kkfileview-redis
#    restart: always
#    ports:
#      - "6379:6379"
#    volumes:
#      - ./data/redis:/data
#    networks:
#      - kkfileview-network
#    command: redis-server --appendonly yes
